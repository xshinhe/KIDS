import os
import re
import sys
import toml
from copy import deepcopy
from pprint import pprint
from traceback import format_exc
import typing
import numpy as np
import numpy.typing as npt

periodic_table = '''
  -----                                                               -----
1 | H |                                                               |He |
  |---+----                                       --------------------+---|
2 |Li |Be |                                       | B | C | N | O | F |Ne |
  |---+---|                                       |---+---+---+---+---+---|
3 |Na |Mg |3B  4B  5B  6B  7B |    8B     |1B  2B |Al |Si | P | S |Cl |Ar |
  |---+---+---------------------------------------+---+---+---+---+---+---|
4 | K |Ca |Sc |Ti | V |Cr |Mn |Fe |Co |Ni |Cu |Zn |Ga |Ge |As |Se |Br |Kr |
  |---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---|
5 |Rb |Sr | Y |Zr |Nb |Mo |Tc |Ru |Rh |Pd |Ag |Cd |In |Sn |Sb |Te | I |Xe |
  |---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---|
6 |Cs |Ba |LAN|Hf |Ta | W |Re |Os |Ir |Pt |Au |Hg |Tl |Pb |Bi |Po |At |Rn |
  |---+---+---+------------------------------------------------------------
7 |Fr |Ra |ACT|
  -------------
              -------------------------------------------------------------
   Lanthanide |La |Ce |Pr |Nd |Pm |Sm |Eu |Gd |Tb |Dy |Ho |Er |Tm |Yb |Lu |
              |---+---+---+---+---+---+---+---+---+---+---+---+---+---+---|
   Actinide   |Ac |Th |Pa | U |Np |Pu |Am |Cm |Bk |Cf |Es |Fm |Md |No |Lw |
              -------------------------------------------------------------
'''

element_list = {
    "NU": ["NU",  0, -1, 0.0          ],
    "H" : ["H" ,  1, -1, 1.007947     ],
    "HE": ["HE",  2, -1, 4.0026022    ],
    "LI": ["LI",  3, -1, 6.9412       ],
    "BE": ["BE",  4, -1, 9.0121823    ],
    "B" : ["B" ,  5, -1, 10.8117      ],
    "C" : ["C" ,  6, -1, 12.01078     ],
    "N" : ["N" ,  7, -1, 14.00672     ],
    "O" : ["O" ,  8, -1, 15.99943     ],
    "F" : ["F" ,  9, -1, 18.99840325  ],
    "NE": ["NE", 10, -1, 20.17976     ],
    "NA": ["NA", 11, -1, 22.989769282 ],
    "MG": ["MG", 12, -1, 24.30506     ],
    "AL": ["AL", 13, -1, 26.98153868  ],
    "SI": ["SI", 14, -1, 28.08553     ],
    "P" : ["P" , 15, -1, 30.9737622   ],
    "S" : ["S" , 16, -1, 32.0655      ],
    "CL": ["CL", 17, -1, 35.4532      ],
    "AR": ["AR", 18, -1, 39.9481      ],
    "K" : ["K" , 19, -1, 39.09831     ],
    "CA": ["CA", 20, -1, 40.0784      ],
    "SC": ["SC", 21, -1, 44.9559126   ],
    "TI": ["TI", 22, -1, 47.8671      ],
    "V" : ["V" , 23, -1, 50.94151     ],
    "CR": ["CR", 24, -1, 51.99616     ],
    "MN": ["MN", 25, -1, 54.9380455   ],
    "FE": ["FE", 26, -1, 55.8452      ],
    "CO": ["CO", 27, -1, 58.9331955   ],
    "NI": ["NI", 28, -1, 58.69342     ],
    "CU": ["CU", 29, -1, 63.5463      ],
    "ZN": ["ZN", 30, -1, 65.4094      ],
    "GA": ["GA", 31, -1, 69.7231      ],
    "GE": ["GE", 32, -1, 72.641       ],
    "AS": ["AS", 33, -1, 74.921602    ],
    "SE": ["SE", 34, -1, 78.963       ],
    "BR": ["BR", 35, -1, 79.9041      ],
    "KR": ["KR", 36, -1, 83.7982      ],
    "RB": ["RB", 37, -1, 85.46783     ],
    "SR": ["SR", 38, -1, 87.621       ],
    "Y" : ["Y" , 39, -1, 88.905852    ],
    "ZR": ["ZR", 40, -1, 91.2242      ],
    "NB": ["NB", 41, -1, 92.906382    ],
    "MO": ["MO", 42, -1, 95.942       ],
    "TC": ["TC", 43, -1, 98.0         ],
    "RU": ["RU", 44, -1, 101.072      ],
    "RH": ["RH", 45, -1, 102.905502   ],
    "PD": ["PD", 46, -1, 106.421      ],
    "AG": ["AG", 47, -1, 107.86822    ],
    "CD": ["CD", 48, -1, 112.4118     ],
    "IN": ["IN", 49, -1, 114.8183     ],
    "SN": ["SN", 50, -1, 118.7107     ],
    "SB": ["SB", 51, -1, 121.7601     ],
    "TE": ["TE", 52, -1, 127.603      ],
    "I" : ["I" , 53, -1, 126.904473   ],
    "XE": ["XE", 54, -1, 131.2936     ],
    "CS": ["CS", 55, -1, 132.90545192 ],
    "BA": ["BA", 56, -1, 137.3277     ],
    "LA": ["LA", 57, -1, 138.905477   ],
    "CE": ["CE", 58, -1, 140.1161     ],
    "PR": ["PR", 59, -1, 140.907652   ],
    "ND": ["ND", 60, -1, 144.2423     ],
    "PM": ["PM", 61, -1, 145.0        ],
    "SM": ["SM", 62, -1, 150.362      ],
    "EU": ["EU", 63, -1, 151.9641     ],
    "GD": ["GD", 64, -1, 157.253      ],
    "TB": ["TB", 65, -1, 158.925352   ],
    "DY": ["DY", 66, -1, 162.5001     ],
    "HO": ["HO", 67, -1, 164.930322   ],
    "ER": ["ER", 68, -1, 167.2593     ],
    "TM": ["TM", 69, -1, 168.934212   ],
    "YB": ["YB", 70, -1, 173.043      ],
    "LU": ["LU", 71, -1, 174.9671     ],
    "HF": ["HF", 72, -1, 178.492      ],
    "TA": ["TA", 73, -1, 180.947882   ],
    "W" : ["W" , 74, -1, 183.841      ],
    "RE": ["RE", 75, -1, 186.2071     ],
    "OS": ["OS", 76, -1, 190.233      ],
    "IR": ["IR", 77, -1, 192.2173     ],
    "PT": ["PT", 78, -1, 195.0849     ],
    "AU": ["AU", 79, -1, 196.9665694  ],
    "HG": ["HG", 80, -1, 200.592      ],
    "TL": ["TL", 81, -1, 204.38332    ],
    "PB": ["PB", 82, -1, 207.21       ],
    "BI": ["BI", 83, -1, 208.980401   ],
    "PO": ["PO", 84, -1, 210.0        ],
    "AT": ["AT", 85, -1, 210.0        ],
    "RN": ["RN", 86, -1, 220.0        ],
    "FR": ["FR", 87, -1, 223.0        ],
    "RA": ["RA", 88, -1, 226.0        ],
    "AC": ["AC", 89, -1, 227.0        ],
    "TH": ["TH", 90, -1, 232.038062   ],
    "PA": ["PA", 91, -1, 231.035882   ],
    "U" : ["U" , 92, -1, 238.028913   ],
    "NP": ["NP", 93, -1, 237.0        ],
    "PU": ["PU", 94, -1, 244.0        ],
    "AM": ["AM", 95, -1, 243.0        ],
    "CM": ["CM", 96, -1, 247.0        ],
    "BK": ["BK", 97, -1, 247.0        ],
    "CF": ["CF", 98, -1, 251.0        ],
    "ES": ["ES", 99, -1, 252.0        ],
    "FM": ["FM",100, -1, 257.0        ],
    "MD": ["MD",101, -1, 258.0        ],
    "NO": ["NO",102, -1, 259.0        ],
    "LR": ["LR",103, -1, 262.0        ],
    "RF": ["RF",104, -1, 261.0        ],
    "DB": ["DB",105, -1, 262.0        ],
    "SG": ["SG",106, -1, 266.0        ],
    "BH": ["BH",107, -1, 264.0        ],
    "HS": ["HS",108, -1, 277.0        ],
    "MT": ["MT",109, -1, 268.0        ],
    "DS": ["DS",110, -1, 271.0        ],
    "RG": ["RG",111, -1, 272.0        ],
    "CN": ["CN",112, -1, 285.0        ],
    "NH": ["NH",113, -1, 284.0        ],
    "FL": ["FL",114, -1, 289.0        ],
    "MC": ["MC",115, -1, 288.0        ],
    "LV": ["LV",116, -1, 292.0        ],
    "TS": ["TS",117, -1, 291.0        ],
    "OG": ["OG",118, -1, 294.0        ],
    #
    0   : ["NU",  0, -1, 0.0          ],
    1   : ["H" ,  1, -1, 1.007947     ],
    2   : ["HE",  2, -1, 4.0026022    ],
    3   : ["LI",  3, -1, 6.9412       ],
    4   : ["BE",  4, -1, 9.0121823    ],
    5   : ["B" ,  5, -1, 10.8117      ],
    6   : ["C" ,  6, -1, 12.01078     ],
    7   : ["N" ,  7, -1, 14.00672     ],
    8   : ["O" ,  8, -1, 15.99943     ],
    9   : ["F" ,  9, -1, 18.99840325  ],
    10  : ["NE", 10, -1, 20.17976     ],
    11  : ["NA", 11, -1, 22.989769282 ],
    12  : ["MG", 12, -1, 24.30506     ],
    13  : ["AL", 13, -1, 26.98153868  ],
    14  : ["SI", 14, -1, 28.08553     ],
    15  : ["P" , 15, -1, 30.9737622   ],
    16  : ["S" , 16, -1, 32.0655      ],
    17  : ["CL", 17, -1, 35.4532      ],
    18  : ["AR", 18, -1, 39.9481      ],
    19  : ["K" , 19, -1, 39.09831     ],
    20  : ["CA", 20, -1, 40.0784      ],
    21  : ["SC", 21, -1, 44.9559126   ],
    22  : ["TI", 22, -1, 47.8671      ],
    23  : ["V" , 23, -1, 50.94151     ],
    24  : ["CR", 24, -1, 51.99616     ],
    25  : ["MN", 25, -1, 54.9380455   ],
    26  : ["FE", 26, -1, 55.8452      ],
    27  : ["CO", 27, -1, 58.9331955   ],
    28  : ["NI", 28, -1, 58.69342     ],
    29  : ["CU", 29, -1, 63.5463      ],
    30  : ["ZN", 30, -1, 65.4094      ],
    31  : ["GA", 31, -1, 69.7231      ],
    32  : ["GE", 32, -1, 72.641       ],
    33  : ["AS", 33, -1, 74.921602    ],
    34  : ["SE", 34, -1, 78.963       ],
    35  : ["BR", 35, -1, 79.9041      ],
    36  : ["KR", 36, -1, 83.7982      ],
    37  : ["RB", 37, -1, 85.46783     ],
    38  : ["SR", 38, -1, 87.621       ],
    39  : ["Y" , 39, -1, 88.905852    ],
    40  : ["ZR", 40, -1, 91.2242      ],
    41  : ["NB", 41, -1, 92.906382    ],
    42  : ["MO", 42, -1, 95.942       ],
    43  : ["TC", 43, -1, 98.0         ],
    44  : ["RU", 44, -1, 101.072      ],
    45  : ["RH", 45, -1, 102.905502   ],
    46  : ["PD", 46, -1, 106.421      ],
    47  : ["AG", 47, -1, 107.86822    ],
    48  : ["CD", 48, -1, 112.4118     ],
    49  : ["IN", 49, -1, 114.8183     ],
    50  : ["SN", 50, -1, 118.7107     ],
    51  : ["SB", 51, -1, 121.7601     ],
    52  : ["TE", 52, -1, 127.603      ],
    53  : ["I" , 53, -1, 126.904473   ],
    54  : ["XE", 54, -1, 131.2936     ],
    55  : ["CS", 55, -1, 132.90545192 ],
    56  : ["BA", 56, -1, 137.3277     ],
    57  : ["LA", 57, -1, 138.905477   ],
    58  : ["CE", 58, -1, 140.1161     ],
    59  : ["PR", 59, -1, 140.907652   ],
    60  : ["ND", 60, -1, 144.2423     ],
    61  : ["PM", 61, -1, 145.0        ],
    62  : ["SM", 62, -1, 150.362      ],
    63  : ["EU", 63, -1, 151.9641     ],
    64  : ["GD", 64, -1, 157.253      ],
    65  : ["TB", 65, -1, 158.925352   ],
    66  : ["DY", 66, -1, 162.5001     ],
    67  : ["HO", 67, -1, 164.930322   ],
    68  : ["ER", 68, -1, 167.2593     ],
    69  : ["TM", 69, -1, 168.934212   ],
    70  : ["YB", 70, -1, 173.043      ],
    71  : ["LU", 71, -1, 174.9671     ],
    72  : ["HF", 72, -1, 178.492      ],
    73  : ["TA", 73, -1, 180.947882   ],
    74  : ["W" , 74, -1, 183.841      ],
    75  : ["RE", 75, -1, 186.2071     ],
    76  : ["OS", 76, -1, 190.233      ],
    77  : ["IR", 77, -1, 192.2173     ],
    78  : ["PT", 78, -1, 195.0849     ],
    79  : ["AU", 79, -1, 196.9665694  ],
    80  : ["HG", 80, -1, 200.592      ],
    81  : ["TL", 81, -1, 204.38332    ],
    82  : ["PB", 82, -1, 207.21       ],
    83  : ["BI", 83, -1, 208.980401   ],
    84  : ["PO", 84, -1, 210.0        ],
    85  : ["AT", 85, -1, 210.0        ],
    86  : ["RN", 86, -1, 220.0        ],
    87  : ["FR", 87, -1, 223.0        ],
    88  : ["RA", 88, -1, 226.0        ],
    89  : ["AC", 89, -1, 227.0        ],
    90  : ["TH", 90, -1, 232.038062   ],
    91  : ["PA", 91, -1, 231.035882   ],
    92  : ["U" , 92, -1, 238.028913   ],
    93  : ["NP", 93, -1, 237.0        ],
    94  : ["PU", 94, -1, 244.0        ],
    95  : ["AM", 95, -1, 243.0        ],
    96  : ["CM", 96, -1, 247.0        ],
    97  : ["BK", 97, -1, 247.0        ],
    98  : ["CF", 98, -1, 251.0        ],
    99  : ["ES", 99, -1, 252.0        ],
    100 : ["FM",100, -1, 257.0        ],
    101 : ["MD",101, -1, 258.0        ],
    102 : ["NO",102, -1, 259.0        ],
    103 : ["LR",103, -1, 262.0        ],
    104 : ["RF",104, -1, 261.0        ],
    105 : ["DB",105, -1, 262.0        ],
    106 : ["SG",106, -1, 266.0        ],
    107 : ["BH",107, -1, 264.0        ],
    108 : ["HS",108, -1, 277.0        ],
    109 : ["MT",109, -1, 268.0        ],
    110 : ["DS",110, -1, 271.0        ],
    111 : ["RG",111, -1, 272.0        ],
    112 : ["CN",112, -1, 285.0        ],
    113 : ["NH",113, -1, 284.0        ],
    114 : ["FL",114, -1, 289.0        ],
    115 : ["MC",115, -1, 288.0        ],
    116 : ["LV",116, -1, 292.0        ],
    117 : ["TS",117, -1, 291.0        ],
    118 : ["OG",118, -1, 294.0        ],
}

def readfile(filename: str):
    try:
        f = open(filename)
        out = f.readlines()
        f.close()
    except IOError:
        print('File {filename} does not exist!', format_exc())
        sys.exit(-1)
    return out

def writefile(filename, content):
    # content can be either a string or a list of strings
    try:
        f = open(filename, 'w')
        if isinstance(content, list):
            for line in content:
                f.write(line)
        elif isinstance(content, str):
            f.write(content)
        else:
            print('content {content} cannot be written to file!')
        f.close()
    except IOError:
        print('Could not write to file {filename}!', format_exc())
        sys.exit(-1)

def parseQMinput(filename: str):
    lines = readfile(filename)
    try:
        natom = int(lines[0])
    except ValueError:
        print('First line must be the number of atoms!', format_exc())
        sys.exit(-1)
    if len(lines) < natom + 4:
        print("too few lines")
        sys.exit(-1)

    geom_xyz = []
    velocity = [] # or momentum be better?
    znumber  = [] 
    has_velocity = True
    for i in range(2, natom + 2):
        fields = lines[i].split()
        fields[0] = fields[0].title()
        for j in range(1, 4):
            fields[j] = float(fields[j])
        if len(fields) >= 7 and has_velocity:
            for j in range(4, 7):
                fields[j] = float(fields[j])
        else:
            has_velocity = False
        try:
            znumber += [ element_list[fields[0]][1] ]
        except ValueError:
            print("Unknown element {field[0]}")
        geom_xyz +=  [fields[0:4]]
        if has_velocity: 
            velocity +=  [fields[4:7]]
    
    toml_string = ''.join(lines[natom + 2:])
    qm_config = toml.loads(toml_string)

    # pprint(znumber)
    # pprint(geom_xyz)
    # pprint(qm_config)

    return {
        "natom" : natom,
        "znumber" : znumber,
        "geom_xyz" : geom_xyz,
        "velocity" : velocity,
        "qm_config": qm_config
    }

class QMout(typing.TypedDict):
    natom: int
    energy: npt.ArrayLike
    gradient: npt.ArrayLike 
    nacv: npt.ArrayLike
